---
layout: post
title:  Composeë¡œ ì¡¸í”„ ë§Œë“¤ê¸° Part.4 - ì»´í¬ì €ë¸” ìº¡ì³ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°°í¬ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…, Hardware Bitmap (Software rendering doesn't support hardware bitmaps)
date:   2023-07-06 19:39:00 +0900
categories:   Android
---

## í”„ë¡œì íŠ¸ ìš”êµ¬ì‚¬í•­

- ë„¤ì´ë²„ ë§µì„ ì‚¬ìš©í•´ì„œ ë‹¬ë¦° ê²½ë¡œë¥¼ ì§€ë„ì™€ í•¨ê»˜ ë³´ì—¬ì¤˜ì•¼ í•¨(í¬ìŠ¤íŒ… ê¸°ëŠ¥)

ë„¤ì´ë²„ ì§€ë„ API PathOverlay.setCoords() ë¥¼ í™œìš©í•´ì„œ ì‰½ê²Œ êµ¬í˜„ ê°€ëŠ¥
í•˜ì§€ë§Œ __ì§€ë„ ëŒ€ì‹  ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì´ë¯¸ì§€ë¡œ ë°°ê²½ ì„ íƒ ê°€ëŠ¥__ í•˜ë„ë¡ ë§Œë“¤ì–´ì•¼ í•œë‹¤.

ì•„ë˜ ì‚¬ì§„ì´ í•´ë‹¹ ê¸°ëŠ¥ ëª¨ìŠµì´ë‹¤.

![image](https://github.com/Team-Walkie/Walkie/assets/65655825/e9ad7800-fc71-4ee4-ac67-fb85553b866f)

<br>

---


<br>

# ì‹œë„í–ˆë˜ ë°©ë²•...

__ê° ì•„ì´íƒ¬ë§ˆë‹¤ NaverMap ì„ ë³´ì—¬ì¤€ë‹¤__

ì•„ë˜ ì œê³µë˜ëŠ” API ë“¤ë¡œ ì§€ë„ ê°ì²´ë¥¼ í•˜ë‚˜ì˜ ì•„ì´íƒ¬ìœ¼ë¡œ ë³´ê³  ë°°ê²½ ì´ë¯¸ì§€, ê²½ë¡œ ë“±ì„ ê·¸ë¦¬ëŠ” ë°©ë²•ì´ë‹¤.

<pre><code>PathOverlay.setCoords() // ê²½ë¡œ ìƒì„± ê°€ëŠ¥
GroundOverlay.setImage() // ë°°ê²½ ì´ë¯¸ì§€ ì„ íƒ ê°€ëŠ¥</code></pre>

<br>

__ì¥ì __ : ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ ì§€ë„, ì‚¬ì§„ì„ ëª¨ë‘ ë°°ê²½ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë©° ê²½ë¡œ ë˜í•œ ì¼ê´€ëœ ë°©ì‹ìœ¼ë¡œ ë³´ì—¬ì¤„ ìˆ˜ ìˆë‹¤.

__ë‹¨ì __ : ì•± ì„±ëŠ¥ ì €í•˜, ë Œë”ë§ ê³¼ë¶€í™”, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ 

> ì•„ì´íƒ¬ë§ˆë‹¤ ë„¤ì´ë²„ ì§€ë„ ê°ì²´ë¥¼ ìƒì„±í•˜ê³  ì´ë¯¸ì§€ì™€ ê²½ë¡œë¥¼ ë‹¤ì‹œ ê·¸ë ¤ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì„±ëŠ¥, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°œìƒ

@@@ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì‚¬ì§„@@@@@@@

<br>

---

# ì±„íƒëœ ê°œì„  ë°©ì•ˆ 

__ë„¤ì´ë²„ ì§€ë„ ë°°ê²½ì„ ìº¡ì³í•´ì„œ ì‚¬ìš©__

ë‹¬ë¦¬ê¸° ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•˜ëŠ” í˜ì´ì§€ì—ì„œ ì§€ë„ í•˜ë‚˜ë§Œì„ ì‚¬ìš©, í¬ìŠ¤íŒ…í•  ë• ì§€ë„ ìŠ¤í¬ë¦°ìƒ·ì„ ì œê³µí•´ì„œ ì €ì¥í•œë‹¤.

ì•„ë˜ ì½”ë“œëŠ” ìœ„ ì±„íƒëœ ë°©ë²•ì„ ì²˜ìŒ êµ¬í˜„í–ˆë˜ ì½”ë“œì´ë‹¤.


```kotlin
// The CompositionLocal containing the current Compose View.
val view = LocalView.current

// Composableì˜ ìœ„ì¹˜ ì •ë³´ë¥¼ Rectë¡œ ë°›ê¸°
var composableBounds by remember {
    mutableStateOf<Rect?>(null)
}
Modifier.onGloballyPositioned {
    composableBounds = it.boundsInWindow()
}

LaunchedEffect(true) {
    val bmp = Bitmap.createBitmap(
        view.width,
        view.height,
        Bitmap.Config.ARGB_8888,
    ).applyCanvas {
        view.draw(this)
    }
}
```

<br>

- __ì»´í¬ì €ë¸” ìœ„ì¹˜ ì •ë³´ë¥¼ Rectë¡œ ë°›ëŠ” ë²•__
    OnGloballyPositionedModifierëŠ” Modifierì˜ ì¼ì¢…ìœ¼ë¡œ, ì½˜í…ì¸ ì˜ ì „ì—­ í¬ì§€ì…˜ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ ë ˆì´ì•„ì›ƒì˜ ìµœì¢… LayoutCoordinatesì™€ í•¨ê»˜ onGloballyPositioned ì½œë°±ì„ í˜¸ì¶œí•œë‹¤. ì¢Œí‘œë¥¼ í¬í•¨í•˜ê³  ìˆëŠ” ì´ ì½œë°±ì€ Composition(êµ¬ì„±)ì´ ëë‚¬ì„ ë•Œ í˜¸ì¶œ ë¨ì„ ëª…ì‹¬í•˜ì.

```kotlin
Column(
    Modifier.onGloballyPositioned { coordinates ->
        // Columnì˜ ì‚¬ì´ì¦ˆ
        coordinates.size
        // ì• í”Œë¦¬ì¼€ì´ì…˜ ìœˆë„ìš°ì— ìƒëŒ€ì ì¸ Columnì˜ í¬ì§€ì…˜
        coordinates.positionInWindow()
        // ì»´í¬ì¦ˆ ìµœìƒìœ„ì— ìƒëŒ€ì ì¸ Columnì˜ í¬ì§€ì…˜
        coordinates.positionInRoot()
        // ë ˆì´ì•„ì›ƒì— ì œê³µë˜ëŠ” ì •ë ¬ ë¼ì¸ (Columnì˜ ê²½ìš° ë¹„ì–´ìˆìŒ)
        coordinates.providedAlignmentLines
        //  Columnì˜ ë¶€ëª¨ì— í•´ë‹¹í•˜ëŠ” LayoutCoordinates ì¸ìŠ¤í„´ìŠ¤
        coordinates.parentLayoutCoordinates
    }
) {
...
}
```

<br>

---

## __ì˜ˆì™¸ ë°œìƒ__

__java.lang.IllegalArgumentException: Software rendering doesn't support hardware bitmaps__


<img width="913" alt="á„‰á…³á„á…³á„…á…µá†«á„‰á…£á†º á„‹á…¦á„…á…¥" src="https://github.com/fornewid/naver-map-compose/assets/65655825/5b23a315-5875-48b0-9059-a8101083a0d7">

<br>

### __HARDWARE BITMAP??__

ì•„ë˜ ê³µì‹ ë¬¸ì„œë¥¼ í™•ì¸í•´ë³´ë©´ Harware Bitmapì€ ì˜¤ì§ ê·¸ë˜í”½ ë©”ëª¨ë¦¬ì•ˆì— í”½ì…€ì •ë³´ê°€ ì €ì¥ë˜ë©° ì˜¤ì§ í™”ë©´ì— ë„ìš¸ë•Œë§Œ ìµœì í™”ë˜ì—ˆë‹¤ê³  ë‚˜ì˜¨ë‹¤.

https://developer.android.com/reference/android/graphics/Bitmap.Config.html#HARDWARE

> Special configuration, when bitmap is stored only in graphic memory. Bitmaps in this configuration are always immutable. It is optimal for cases, when the only operation with the bitmap is to draw it on a screen.


ì¼ë°˜ì ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ëª¨ë¦¬(í”½ì…€ ë°”ì´íŠ¸ ë°°ì—´)ì— í”½ì…€ ë°ì´í„° ì‚¬ë³¸ í•˜ë‚˜ì™€ ê·¸ë˜í”½ ë©”ëª¨ë¦¬(í”½ì…€ì´ GPUì— ì—…ë¡œë“œëœ í›„)ì— í•˜ë‚˜ì˜ ì‚¬ë³¸ì´ ìˆìŠµë‹ˆë‹¤. í•˜ë“œì›¨ì–´ ë¹„íŠ¸ë§µì€ GPUì— ì—…ë¡œë“œëœ ë³µì‚¬ë³¸ë§Œ ìœ ì§€í•©ë‹ˆë‹¤.

ê·¸ë˜í”½ ë©”ëª¨ë¦¬ì— í”½ì…€ ë°ì´í„°ë¥¼ ì €ì¥í•œë‹¤ëŠ” ê²ƒì€ í”½ì…€ ë°ì´í„°ì— ì‰½ê²Œ ì•¡ì„¸ìŠ¤í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì„ ì˜ë¯¸í•˜ë©°, ê²½ìš°ì— ë”°ë¼ ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

ì•„ë˜ __Glide__ ê³µì‹ ë¬¸ì„œëŠ” `Software rendering doesn't support hardware bitmaps` ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ìƒí™©ê³¼ ì¼ë¶€ ëŒ€ì²˜ ë°©ë²•ì„ ì •ì˜í–ˆê³  ì´ì— ë”°ë¼ ì½”ë“œë¥¼ ìˆ˜ì •í–ˆë‹¤.

ìŠ¤í¬ë¦°ìƒ·ì„ ìœ„í•´ì„œëŠ” Android 8.0 Oreo(API 26) ì´ìƒ ë²„ì „ì—ì„œ `PixelCopy.request()`ë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

https://bumptech.github.io/glide/doc/hardwarebitmaps.html#whats-broken-when-we-use-hardware-bitmaps

```kotlin
    composableBounds = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
        it.boundsInWindow()
    } else {
        it.boundsInRoot()
    }
    
    // Android 8.0 Oreo(API 26) ë²„ì „ ì´í›„ëŠ” PixelCopy.request() APIë¥¼ ì‚¬ìš©í•´ì•¼í•¨
    if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
        PixelCopy.request(
            (view.context as Activity).window,
            bounds.toAndroidRect(),
            bitmap,
            {},
            Handler(Looper.getMainLooper())
        )
    } else {
        val canvas = Canvas(bitmap)
            .apply {
                translate(-bounds.left, -bounds.top)
            }
        this.draw(canvas)
        canvas.setBitmap(null)
    }
```

<br>

---


##  __ìº¡ì³ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°°í¬__

ì»´í¬ì €ë¸”ë¡œ ë§Œë“  í™”ë©´ì„ ìº¡ì³í•˜ëŠ” ì½”ë“œë¥¼ ì¬í™œìš©í•˜ê¸° ìœ„í•´ ëª¨ë“ˆí™”, ë°°í¬ë¥¼ ì¤€ë¹„í–ˆë‹¤.

- __CaptureReusult__ : sealed Classë¡œ `Initialized`, `Success`, `Error` ì˜ í•˜ìœ„ íƒ€ì…ì„ ê°–ëŠ”ë‹¤.

```kotlin
sealed class CaptureResult {
    object Initialized : CaptureResult()
    data class Success internal constructor(val bitmap: Bitmap) : CaptureResult()
    data class Error internal constructor(val exception: Exception) : CaptureResult()
}
```

<br>

- __CaptureState__ : CaptureReusult state í˜•íƒœë¡œ ê°–ê³ ìˆìœ¼ë©° `capture()` í•¨ìˆ˜ ë…¸ì¶œí•´ `Capture` ì˜ `content`ë¥¼ ìº¡ì³í•¨.

```kotlin
class CaptureState internal constructor() {

    val state = mutableStateOf<CaptureResult>(CaptureResult.Initialized)

    //...
    
    fun capture() {
        captureBlock?.invoke()
    }
}

@Composable
fun rememberCaptureState() = remember {
    CaptureState()
}
```

<br>

- __Capture__ : `@Composable function`ìœ¼ë¡œ CaptureStateë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ê³  `contents`ê°€ ìº¡ì³ ê°€ëŠ¥í•˜ë‹¤. ìº¡ì³ëœ í™”ë©´ì€ Bitmapì˜ í˜•íƒœë¡œ `captureState.state : CaptureReusult.Success(bitmap: Bitmap)`ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•˜ë‹¤.

<br>

---

[CaptureComposable Github Repo]: https://github.com/yonghanJu/CaptureComposable/tree/v1.0.2

# [CaptureComposable Github Repo]

[![](https://jitpack.io/v/yonghanJu/CaptureComposable.svg)](https://jitpack.io/#yonghanJu/CaptureComposable)

Library for capturing Composable components  

- __app module__ is demo app

- __capture module__ is Android Library for capturing composable contains and contains `CaptureState`, `CaptureResult`, `@Composable Capture`


## How to
To get a Git project into your build:

### Step 1. Add the JitPack repository to your build file

Add it in your root build.gradle at the end of repositories:
```kotlin
// root level settings.gradle.kts
repositories {
    // ...
    maven("https://jitpack.io")
}
```

### Step 2. Add the dependency
```kotlin
// module level build.gradle.kts 
dependencies {
    val latestVersion = "1.0.2" 
    implementation("com.github.yonghanJu:CaptureComposable:$latestVersion")
}
```

<br>

## Example Code
```kotlin
val captureState = rememberCaptureState()

Capture(
    modifier = Modifier
    captureState = captureState,
) {
    // @Composable content
}

// Captured
Button(onClick = { captureState.capture() })

// ...

// you can use these
captureState.bitmap // captured bitmap
captureState.state // capturedState(Initialized, Success(bitmap), Error(e))
```

## ğŸ˜ ë™ì‘í™”ë©´
<img src="https://github.com/yonghanJu/CaptureComposable/assets/65655825/f80e253a-74de-4d11-af78-c6a9b4ac270c" width="250" height="500"/>

